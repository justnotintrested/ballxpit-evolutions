<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ball x Pit — Evolution Matrix (interactive)</title>
<style>
  :root{
    --bg:#111; --panel:#222; --muted:#1a1a1a; --text:#eee; --accent:#2ecc71; --warn:#f39c12; --border:#444;
  }
  .light {
    --bg:#fafafa; --panel:#fff; --muted:#f2f2f2; --text:#111; --accent:#0a7c3d; --warn:#b55a00; --border:#ddd;
  }
  body { background:var(--bg); color:var(--text); font-family:system-ui,Arial; margin:18px; }
  header { display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
  h1{font-size:18px;margin:0}
  .controls { display:flex; gap:8px; align-items:center; }
  button { background:var(--panel); color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:6px; cursor:pointer; }
  button:active{transform:translateY(1px)}
  .small { font-size:13px; padding:6px 8px; }

  /* Matrix table */
  .matrix-wrap { overflow:auto; border-radius:8px; padding:6px; background:var(--panel); border:1px solid var(--border); }
  table { border-collapse:collapse; width:100%; table-layout:fixed; }
  th, td { border:1px solid var(--border); width:90px; height:90px; padding:4px; text-align:center; vertical-align:middle; overflow:hidden; }
  th { background:var(--panel); font-size:12px; }
  td { background:var(--muted); cursor:pointer; font-size:12px; transition:background .12s; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; }
  td.empty { background:transparent; cursor:default; }
  td.self { background:#666; color:#bbb; cursor:default; }
  td.evo-found { background: rgba(46,204,113,0.12); border-color: rgba(46,204,113,0.25); }
  td.evo-missing { background: rgba(243,156,18,0.08); border-color: rgba(243,156,18,0.18); }
  td img, th img { width:40px; height:40px; object-fit:contain; display:block; margin:0 auto; }

  /* tooltip */
  #tooltip { position:fixed; pointer-events:none; display:none; z-index:9999; background:var(--panel); border:1px solid var(--border); padding:8px; border-radius:6px; width:220px; box-shadow:0 6px 18px rgba(0,0,0,.5); }
  #tooltip img { width:56px; height:56px; display:block; margin:0 auto 6px auto; }
  #tooltip h4 { margin:0 0 6px 0; font-size:14px; text-align:center; }
  #tooltip p { margin:0; font-size:12px; color:var(--text); max-height:80px; overflow:auto; }

  /* popup editor */
  .modal-bg { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:10000; }
  .modal { background:var(--panel); padding:14px; border-radius:8px; width:360px; border:1px solid var(--border); }
  .modal h3{margin-top:0}
  .field{margin:8px 0; display:flex; flex-direction:column; gap:6px; }
  label{font-size:13px}
  input[type="text"], textarea { padding:8px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--text); width:100%; box-sizing:border-box; }
  textarea{ min-height:80px; resize:vertical; }
  .row { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }

  /* small helpers */
  .muted { font-size:12px; color:#9aa; }
  .center { text-align:center; }
  .kbd { font-family:monospace; background:var(--muted); padding:3px 6px; border-radius:4px; font-size:12px; border:1px solid var(--border); }
  @media (max-width:720px){ th, td{ width:72px; height:72px } }
</style>
</head>
<body>

<header>
  <div>
    <h1>Ball x Pit — Evolution Matrix</h1>
    <div class="muted">Click a cell to view/edit. Hover for quick preview.</div>
  </div>

  <div class="controls">
    <button id="themeBtn" class="small">Toggle Theme</button>
    <button id="downloadBtn" class="small">Download evolutions.json</button>
    <button id="clearBtn" class="small">Reset (reload)</button>
  </div>
</header>

<div class="matrix-wrap" id="matrixWrap">
  <div id="matrix"></div>
</div>

<!-- hover tooltip -->
<div id="tooltip" role="tooltip" aria-hidden="true">
  <img id="ttImg" src="">
  <h4 id="ttTitle"></h4>
  <p id="ttText"></p>
</div>

<!-- edit modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle">Edit Evolution</h3>

    <div class="field">
      <label>Row</label>
      <input type="text" id="inpRow" disabled>
    </div>

    <div class="field">
      <label>Column</label>
      <input type="text" id="inpCol" disabled>
    </div>

    <div class="field">
      <label>Evolution name</label>
      <input type="text" id="inpName" placeholder="BOMB">
    </div>

    <div class="field">
      <label>Combo (display)</label>
      <input type="text" id="inpCombo" placeholder="BURN + IRON">
    </div>

    <div class="field">
      <label>Effect text</label>
      <textarea id="inpEffect" placeholder="Explodes dealing..."></textarea>
    </div>

    <div class="field">
      <label>Image filename (in img/)</label>
      <input type="text" id="inpImg" placeholder="bomb.png">
      <div class="muted">Use snake_case filenames like <span class="kbd">bomb.png</span></div>
    </div>

    <div class="row">
      <button id="delBtn" class="small">Delete</button>
      <button id="saveBtn" class="small">Save</button>
      <button id="cancelBtn" class="small">Cancel</button>
    </div>
  </div>
</div>

<!-- notes -->
<div style="margin-top:10px;" class="muted">
  Put icons in <span class="kbd">img/</span> using snake_case (e.g. <span class="kbd">brood_mother.png</span>). The table will auto-load them.
</div>

<script>
/* ====== DATA LOAD ====== */
let baseBalls = [];
let evolutions = [];

/* load base + evolutions; fallback to empty arrays on error */
async function loadData(){
  try {
    const [bRes, eRes] = await Promise.all([
      fetch('base.json'), fetch('evolutions.json')
    ]);
    baseBalls = bRes.ok ? await bRes.json() : [];
    evolutions = eRes.ok ? await eRes.json() : [];
  } catch (err) {
    console.warn('Could not fetch JSON; starting empty', err);
    baseBalls = [];
    evolutions = [];
  }
}

function saveAndRender(){
  renderMatrix();
}

/* initial */
(async ()=>{
  await loadData();
  // if base empty, create sample base list (safety)
  if(!baseBalls || baseBalls.length===0){
    const names = ["BLEED","BROOD MOTHER","BURN","CELL","CHARM","DARK","EARTHQUAKE","EGG SAC","FREEZE","GHOST","IRON","LAZER H","LAZER V","LIGHT","LIGHTNING","POISON","VAMPIRE","WIND"];
    baseBalls = names.map(n=>({name:n, img: n.toLowerCase().replace(/ /g,'_') + '.png'}));
  }
  renderMatrix();
})();

/* ====== RENDER ====== */
const matrixEl = document.getElementById('matrix');
const tooltip = document.getElementById('tooltip');
let currentTheme = localStorage.getItem('bxp_theme') || 'dark';
if(currentTheme==='light') document.body.classList.add('light');

function renderMatrix(){
  const names = baseBalls.map(x=>x.name);
  let html = '<table><tr><th></th>';
  names.forEach(n => {
    html += `<th><img src="img/${toFile(n)}" onerror="this.style.opacity=.25"><div style="margin-top:6px;font-size:12px">${short(n)}</div></th>`;
  });
  html += '</tr>';
  names.forEach(row => {
    html += `<tr><th><img src="img/${toFile(row)}" onerror="this.style.opacity=.25"><div style="margin-top:6px;font-size:12px">${short(row)}</div></th>`;
    names.forEach(col => {
      if(row===col){
        html += `<td class="self" data-row="${row}" data-col="${col}">—</td>`;
        return;
      }
      const found = evolutions.find(e=> e.row===row && e.col===col);
      if(found){
        html += `<td class="evo-found" data-row="${row}" data-col="${col}" data-name="${escapeAttr(found.name)}" data-img="${escapeAttr(found.img || '')}" data-combo="${escapeAttr(found.combo||'')}" data-effect="${escapeAttr(found.effect||'')}">
                  <img src="img/${(found.img||'').replace(/ /g,'')}" onerror="this.style.opacity=.25">
                  <div style="font-size:11px">${short(found.name)}</div>
                 </td>`;
      } else {
        html += `<td class="evo-missing" data-row="${row}" data-col="${col}"></td>`;
      }
    });
    html += '</tr>';
  });
  html += '</table>';
  matrixEl.innerHTML = html;

  // attach events
  matrixEl.querySelectorAll('td').forEach(td=>{
    if(td.classList.contains('self')) return;
    td.addEventListener('mouseenter', onHover);
    td.addEventListener('mousemove', onMove);
    td.addEventListener('mouseleave', onLeave);
    td.addEventListener('click', onClickCell);
  });
}

/* helper to shorten long names visually */
function short(s){ return s.length>12 ? s.slice(0,11)+'…' : s; }
function toFile(name){ return name.toLowerCase().replace(/ /g,'_') + ".png"; }
function escapeAttr(s){ return String(s || '').replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }

/* ===== TOOLTIP HANDLERS ===== */
function onHover(e){
  const td = e.currentTarget;
  const name = td.getAttribute('data-name');
  const img = td.getAttribute('data-img') || '';
  const combo = td.getAttribute('data-combo') || '';
  const effect = td.getAttribute('data-effect') || '';
  if(!name){
    // missing evolution: show quick "click to add"
    tooltip.style.display = 'block';
    document.getElementById('ttImg').src = 'img/placeholder.png';
    document.getElementById('ttTitle').innerText = 'No evolution';
    document.getElementById('ttText').innerText = 'Click to add an evolution for this cell.';
  } else {
    tooltip.style.display = 'block';
    document.getElementById('ttImg').src = img ? ('img/' + img) : ('img/' + name.toLowerCase().replace(/ /g,'_') + '.png');
    document.getElementById('ttTitle').innerText = name;
    document.getElementById('ttText').innerText = combo ? combo + '\\n\\n' + (effect || '') : (effect || '');
  }
  onMove(e);
}
function onMove(e){
  tooltip.style.left = (e.pageX + 14) + 'px';
  tooltip.style.top = (e.pageY + 14) + 'px';
}
function onLeave(){
  tooltip.style.display = 'none';
}

/* ===== CLICK (open editor) ===== */
const modalBg = document.getElementById('modalBg');
const inpRow = document.getElementById('inpRow');
const inpCol = document.getElementById('inpCol');
const inpName = document.getElementById('inpName');
const inpCombo = document.getElementById('inpCombo');
const inpEffect = document.getElementById('inpEffect');
const inpImg = document.getElementById('inpImg');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const delBtn = document.getElementById('delBtn');

let editing = null;

function onClickCell(e){
  const td = e.currentTarget;
  const row = td.dataset.row, col = td.dataset.col;
  editing = { row, col };
  inpRow.value = row; inpCol.value = col;
  const found = evolutions.find(x=> x.row===row && x.col===col);
  if(found){
    inpName.value = found.name || '';
    inpCombo.value = found.combo || '';
    inpEffect.value = found.effect || '';
    inpImg.value = found.img || '';
    delBtn.style.display = 'inline-block';
  } else {
    inpName.value = ''; inpCombo.value = `${row} + ${col}`; inpEffect.value=''; inpImg.value='';
    delBtn.style.display = 'none';
  }
  modalBg.style.display='flex';
}

cancelBtn.onclick = ()=> { modalBg.style.display='none'; editing=null; };
delBtn.onclick = ()=>{
  if(!editing) return;
  evolutions = evolutions.filter(x=> !(x.row===editing.row && x.col===editing.col));
  modalBg.style.display='none';
  saveAndRender();
};
saveBtn.onclick = ()=>{
  if(!editing) return;
  const obj = {
    row: editing.row,
    col: editing.col,
    name: inpName.value.trim(),
    combo: inpCombo.value.trim(),
    effect: inpEffect.value.trim(),
    img: inpImg.value.trim()
  };
  // remove existing
  evolutions = evolutions.filter(x=> !(x.row===obj.row && x.col===obj.col));
  // only add if name provided
  if(obj.name) evolutions.push(obj);
  modalBg.style.display='none';
  saveAndRender();
};

/* allow pressing Enter on inputs to save quickly */
[inpName, inpCombo, inpImg].forEach(el=>{
  el.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); saveBtn.click(); }});
});

/* ===== DOWNLOAD / THEME / CLEAR ===== */
document.getElementById('downloadBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify(evolutions, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'evolutions.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
};

document.getElementById('clearBtn').onclick = ()=> location.reload();

document.getElementById('themeBtn').onclick = ()=>{
  if(document.body.classList.toggle('light')){
    localStorage.setItem('bxp_theme','light');
  } else {
    localStorage.setItem('bxp_theme','dark');
  }
};

/* small utilities */
function findBaseIndex(name){
  return baseBalls.findIndex(b=> b.name===name);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
</script>
</body>
</html>
